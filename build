#!/usr/bin/env python3

import os
import subprocess
import sys

# Bootstrapping
# =============

# Make sure the KNinja repo is available.
#
subprocess.check_call(['git', 'submodule', 'update', '--init', '--recursive'])
extdir = '.build'
sys.path.append(os.path.join(os.path.dirname(__file__), extdir))

from kninja import *

# Build
# =====

proj = KProject(extdir = extdir)
def build_wasm(backend, flags = ''):
    return proj.definition( alias             = 'wasm-' + backend
                          , backend           = backend
                          , main              = 'test.md'
                          , other             = [ 'wasm.md', 'data.md', 'kwasm-lemmas.md' ]
                          , directory         = proj.builddir('defn', backend)
                          , runner_script     = './kwasm'
                          , flags             = '--main-module WASM-TEST --syntax-module WASM-TEST ' \
                                              + flags
                          )
wasm_java = build_wasm(backend = 'java')
wasm_ocaml = build_wasm(backend = 'ocaml', flags = '-O3 --non-strict')
wasm_haskell = build_wasm(backend = 'haskell')

# Testing
# =======

concrete_backend = wasm_ocaml
symbolic_backend = wasm_java

def test_exec(name, glob, defn, backend):
    defn.tests( glob = glob
              , alias = 'test-' + name + '-' + backend
              , expected = 'tests/success-' + backend + '.out'
              , default = False
              )

def test_proof(name, glob, defn, backend):
    defn.proofs( glob = glob
               , alias = 'test-' + name + '-' + backend
               , default = False
               )

test_exec('simple',      'tests/simple/*.wast',               wasm_java,  'java')
test_exec('simple',      'tests/simple/*.wast',               wasm_ocaml, 'ocaml')
test_exec('conformance', 'tests/wasm-tests/test/core/*.wast', wasm_ocaml, 'ocaml')

test_proof('prove', 'tests/proofs/*-spec.k', wasm_java,    'java')
test_proof('prove', 'tests/proofs/*-spec.k', wasm_haskell, 'haskell')

proj.alias(name = 'test-exec',        targets = 'test-exec-java')
proj.alias(name = 'test-simple',      targets = 'test-simple-java')
proj.alias(name = 'test-conformance', targets = 'test-conformance-ocaml')
proj.alias(name = 'test-proofs',      targets = 'test-proofs-java')

proj.default(['test-exec', 'test-simple', 'test-proofs'])

# Main
# ====

proj.main()
